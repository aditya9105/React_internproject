<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>React Table with Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .sort-icons {
      font-size: 0.75rem;
      margin-left: 5px;
      color: #ccc;
    }
    th.sorted-asc .sort-icons .up {
      color: #000;
      font-weight: bold;
    }
    th.sorted-desc .sort-icons .down {
      color: #000;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h2>Saved Entries</h2>
    <div class="mb-3">
      <a href="index.html" class="btn btn-primary">â¬… Back to Main Page</a>
    </div>
    <div class="mb-3 d-flex justify-content-end">
      <input type="text" id="searchInput" class="form-control w-25" placeholder="ðŸ” Search..." />
    </div>
    <div id="root"></div>
  </div>

  <!-- React, ReactDOM -->
  <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js"></script>

  <!-- Babel for JSX -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>

  <!-- react-table -->
  <script src="https://cdn.jsdelivr.net/npm/react-table@7.8.0/dist/react-table.development.js"></script>

  <!-- Firebase logic -->
  <script type="module" src="script.js"></script>

  <!-- Main React App -->
  <script type="text/babel">
    const { useTable, usePagination, useSortBy } = ReactTable;

    function Table({ columns, data }) {
      const [searchText, setSearchText] = React.useState("");
      const [sortByState, setSortByState] = React.useState([]);

      const filteredData = React.useMemo(() => {
        if (!searchText.trim()) return data;
        return data.filter(entry =>
          Object.values(entry).some(value =>
            String(value).toLowerCase().includes(searchText.toLowerCase())
          )
        );
      }, [data, searchText]);

      const sortedData = React.useMemo(() => {
        if (sortByState.length === 0) return filteredData;
        const [{ id, desc }] = sortByState;

        return [...filteredData].sort((a, b) => {
          let aVal = a[id];
          let bVal = b[id];

          if (typeof aVal === 'string') aVal = aVal.toLowerCase();
          if (typeof bVal === 'string') bVal = bVal.toLowerCase();

          if (aVal < bVal) return desc ? 1 : -1;
          if (aVal > bVal) return desc ? -1 : 1;
          return 0;
        });
      }, [filteredData, sortByState]);

      const {
        getTableProps,
        getTableBodyProps,
        headerGroups,
        prepareRow,
        page,
        nextPage,
        previousPage,
        canNextPage,
        canPreviousPage,
        state: { sortBy }
      } = useTable(
        {
          columns,
          data: sortedData,
          initialState: { pageSize: 5, sortBy: [] },
          manualSortBy: true // Important to override react-table's auto sort
        },
        useSortBy,
        usePagination
      );

      // Keep track of sorting column/direction manually
      React.useEffect(() => {
        setSortByState(sortBy);
      }, [sortBy]);

      React.useEffect(() => {
        const input = document.getElementById("searchInput");
        const handler = e => setSearchText(e.target.value);
        input.addEventListener("input", handler);
        return () => input.removeEventListener("input", handler);
      }, []);

      return (
        <>
          <table {...getTableProps()} className="table table-bordered">
            <thead>
              {headerGroups.map(headerGroup => (
                <tr {...headerGroup.getHeaderGroupProps()}>
                  {headerGroup.headers.map(column => {
                    const isSorted = column.isSorted;
                    const isDesc = column.isSortedDesc;
                    return (
                      <th
                        {...column.getHeaderProps(column.getSortByToggleProps())}
                        className={
                          isSorted ? (isDesc ? 'sorted-desc' : 'sorted-asc') : ''
                        }
                      >
                        {column.render('Header')}
                        {!column.disableSortBy && (
                          <span className="sort-icons">
                            <span className="up">â†‘</span>
                            <span className="down">â†“</span>
                          </span>
                        )}
                      </th>
                    );
                  })}
                </tr>
              ))}
            </thead>
            <tbody {...getTableBodyProps()}>
              {page.map(row => {
                prepareRow(row);
                return (
                  <tr {...row.getRowProps()}>
                    {row.cells.map(cell => (
                      <td {...cell.getCellProps()}>{cell.render('Cell')}</td>
                    ))}
                  </tr>
                );
              })}
            </tbody>
          </table>

          <div className="d-flex justify-content-between">
            <button className="btn btn-secondary" onClick={() => previousPage()} disabled={!canPreviousPage}>
              Previous
            </button>
            <button className="btn btn-secondary" onClick={() => nextPage()} disabled={!canNextPage}>
              Next
            </button>
          </div>
        </>
      );
    }

    const columns = [
      { Header: 'First Name', accessor: 'name' },
      { Header: 'Last Name', accessor: 'lastName' },
      { Header: 'Email', accessor: 'email' },
      { Header: 'Mobile', accessor: 'mobile' },
      { Header: 'Company', accessor: 'company' },
      { Header: 'Date of Birth', accessor: 'dob' },
      { Header: 'Gender', accessor: 'gender' },
      {
        Header: 'Image',
        accessor: 'selectedImage',
        disableSortBy: true,
        Cell: ({ value }) =>
          value ? <img src={value} alt="User" style={{ width: '50px', height: '50px', objectFit: 'cover' }} /> : ''
      },
      {
        Header: 'Actions',
        disableSortBy: true,
        Cell: ({ row }) => (
          <>
            <a href={`index.html?id=${row.original.id}`} className="btn btn-sm btn-primary mr-2">Update</a>
            <button className="btn btn-sm btn-danger" onClick={() => window.confirmAndDelete(row.original.id)}>Delete</button>
          </>
        )
      }
    ];

    function App() {
      const [data, setData] = React.useState([]);

      React.useEffect(() => {
        window.listenToFirebase(entries => setData(entries));
      }, []);

      return <Table columns={columns} data={data} />;
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
